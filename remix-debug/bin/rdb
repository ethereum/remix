#!/usr/bin/env node

const program = require('commander')
const version = require('../package.json').version
// const solc = require('solc')
// const fs = require('fs')
const repl = require('repl')

program
  .command('version')
  .description('outputs version number')
  .action(() => {
    console.log(version)
    process.exit(0)
  })

program
  .command('help')
  .description('outputs usage information')
  .action(() => {
    program.help()
    process.exit(0)
  })

program
  .option('-f, --file [filename]', 'solidity filename to debug')
  .option('--tx [txHash]', 'transaction hash to debug')
  .option('--node [url]', 'node to connect to')
  .parse(process.argv)

const CmdLine = require('../src/cmdline/index.js')

const inputJson = {
  language: 'Solidity',
  sources: {
  },
  settings: {
    optimizer: {
      enabled: true,
      runs: 200
    },
    outputSelection: {
      '*': {
        '': [ 'legacyAST' ],
        '*': [ 'abi', 'metadata', 'devdoc', 'userdoc', 'evm.legacyAssembly', 'evm.bytecode', 'evm.deployedBytecode', 'evm.methodIdentifiers', 'evm.gasEstimates' ]
      }
    }
  }
}

// inputJson.sources[shortFilename] = {content: fs.readFileSync(filename).toString()}

console.log('compiling...')

// const compilationData = JSON.parse(solc.compileStandardWrapper(JSON.stringify(inputJson)))
let compilation = {}
compilation.data = {}
compilation.source = { sources: {} }

const cmdLine = new CmdLine()
cmdLine.connect('http', 'https://remix-goerli.ethdevops.io')
cmdLine.loadCompilationResult(compilation)
cmdLine.initDebugger()

const tx = '0x033bf7d78260117b6e260c419238896bf61f2ddb343073bd324400c1ff1f1dcb'

cmdLine.startDebug(tx)

cmdLine.events.on('source', () => {
  cmdLine.getSource().forEach(console.dir)
})

console.log('start')

repl.start({
  prompt: '> ',
  eval: (cmd, context, filename, cb) => {
    let command = cmd.trim()
    if (command === 'next' || command === 'n') {
      cmdLine.stepOverForward(true)
    }
    if (command === 'previous' || command === 'p' || command === 'prev') {
      cmdLine.stepOverBack(true)
    }
    if (command === 'step' || command === 's') {
      cmdLine.stepIntoForward(true)
    }
    if (command === 'stepback' || command === 'sb') {
      cmdLine.stepIntoBack(true)
    }
    if (command === 'exit' || command === 'quit') {
      process.exit(0)
    }
    if (command === 'var local' || command === 'v l' || command === 'vl') {
      cmdLine.displayLocals()
    }
    if (command === 'var global' || command === 'v g' || command === 'vg') {
      cmdLine.displayGlobals()
    }
    if (command.split(' ')[0] === 'jump') {
      let stepIndex = parseInt(command.split(' ')[1], 10)
      cmdLine.jumpTo(stepIndex)
    }
    if (command === 'next' || command === 'n') {
      cmdLine.stepOverForward(true)
    }
    if (command === 'current-step' || command === 'cs') {
      cmdLine.displayCurrentStep()
    }
    cb(null, '')
  }
})

module.exports = cmdLine

